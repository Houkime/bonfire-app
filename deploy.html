<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.28.5">
    <meta name="project" content="bonfire_umbrella v0.4.0-classic-beta.3">

    <title>Deployment guide ‚Äî bonfire_umbrella v0.4.0-classic-beta.3</title>
    <link rel="stylesheet" href="dist/elixir-64c5e2b63575bddb1c5b.css" />

    <script src="dist/sidebar_items-936f767cf3.js"></script>

      <script src="docs_config.js"></script>

    <script async src="dist/app-b5f3440501744dc8be3d.js"></script>


  </head>
  <body data-type="extras">
    <script>

      try {
        var settings = JSON.parse(localStorage.getItem('ex_doc:settings') || '{}');

        if (settings.theme === 'dark' ||
           ((settings.theme === 'system' || settings.theme == null) &&
             window.matchMedia('(prefers-color-scheme: dark)').matches)
           ) {
          document.body.classList.add('dark')
        }
      } catch (error) { }
    </script>

<div class="main">


<section class="sidebar">
  <button class="sidebar-button sidebar-toggle" aria-label="toggle sidebar">
    <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
  </button>

  <form class="sidebar-search" action="search.html">
    <button type="submit" class="search-button" aria-label="Submit Search">
      <i class="ri-search-2-line" aria-hidden="true" title="Submit search"></i>
    </button>
    <button type="button" tabindex="-1" class="search-close-button" aria-label="Cancel Search">
      <i class="ri-close-line ri-lg" aria-hidden="true" title="Cancel search"></i>
    </button>
    <label class="search-label">
      <p class="sr-only">Search</p>
      <input name="q" type="text" class="search-input" placeholder="Search..." aria-label="Input your search terms" autocomplete="off" />
    </label>
  </form>

  <div class="autocomplete">
    <div class="autocomplete-results">
    </div>
  </div>

  <div class="sidebar-header">

      <a href="https://bonfirenetworks.org">
        <img src="assets/logo.png" alt="bonfire_umbrella" class="sidebar-projectImage">
      </a>

    <div class="sidebar-projectDetails">
      <a href="https://bonfirenetworks.org" class="sidebar-projectName" translate="no">
bonfire_umbrella
      </a>
      <strong class="sidebar-projectVersion" translate="no">
        v0.4.0-classic-beta.3
      </strong>
    </div>
    <ul class="sidebar-listNav">
      <li><a id="extras-list-link" href="#full-list">Pages</a></li>

        <li><a id="modules-list-link" href="#full-list">Modules</a></li>


        <li><a id="tasks-list-link" href="#full-list"><span translate="no">Mix</span> Tasks</a></li>

    </ul>
  </div>

  <div class="gradient"></div>
  <ul id="full-list" class="sidebar-fullList"></ul>
</section>

<section class="content">
  <output role="status" id="toast"></output>
  <div class="content-outer">
    <div id="content" class="content-inner">

<h1>
<button class="settings display-settings">
  <i class="ri-settings-3-line"></i>
  <span class="sr-only">Settings</span>
</button>


    <a href="https://github.com/bonfire-networks/bonfire-app/blob/main/docs/DEPLOY.md#L1" title="View Source" class="view-source" rel="help">
      <i class="ri-code-s-slash-line" aria-hidden="true"></i>
      <span class="sr-only">View Source</span>
    </a>

  <span>Deployment guide</span>
</h1>

<h3 id="warning-beta-status-have-fun-but-don-t-rely-on-it-yet" class="section-heading">
  <a href="#warning-beta-status-have-fun-but-don-t-rely-on-it-yet" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">warning-beta-status-have-fun-but-don-t-rely-on-it-yet</p>
  </a>
  WARNING: beta status - have fun but don't rely on it yet üôè
</h3>
<p>Bonfire is currently beta software. While it's fun to play with it, we would not recommend running any production instances yet (meaning not using it for your primary fediverse identity) because it's not quite ready for that today. </p><p><em>These instructions are for setting up Bonfire in production. If you want to run the backend in development, please refer to our <a href="hacking.html">Developer Guide</a>!</em></p><h2 id="security-warning" class="section-heading">
  <a href="#security-warning" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">security-warning</p>
  </a>
  Security Warning
</h2>
<p>We recommend only granting an account to people you trust to minimise the attack surface. Accordingly, Bonfire ships with public registration disabled. The admin panel has an <code class="inline">invite</code> facility. </p><hr class="thin"/><h2 id="step-0-configure-your-database" class="section-heading">
  <a href="#step-0-configure-your-database" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">step-0-configure-your-database</p>
  </a>
  Step 0 - Configure your database
</h2>
<p>You must provide a postgresql database for data storage. We require postgres 12 or above.</p><p>If you are running in a restricted environment such as Amazon RDS, you will need to execute some sql against the database:</p><pre><code class="makeup elixir" translate="no"><span class="nc">CREATE</span><span class="w"> </span><span class="nc">EXTENSION</span><span class="w"> </span><span class="nc">IF</span><span class="w"> </span><span class="nc">NOT</span><span class="w"> </span><span class="nc">EXISTS</span><span class="w"> </span><span class="n">citext</span><span class="p">;</span></code></pre><h2 id="step-1-download-and-configure-the-app" class="section-heading">
  <a href="#step-1-download-and-configure-the-app" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">step-1-download-and-configure-the-app</p>
  </a>
  Step 1 - Download and configure the app
</h2>
<ol><li><p>Install dependencies. You will need to install <a href="https://github.com/casey/just#packages">just</a>, and other requirements such as Docker (check the exact list of requirements based on the option you choose in step 2.)</p></li><li><p>Clone this repository and change into the directory:</p></li></ol><pre><code class="makeup sh" translate="no"><span class="gp unselectable">$ </span><span class="">git clone https://github.com/bonfire-networks/bonfire-app.git bonfire
</span><span class="gp unselectable">$ </span><span class="">cd bonfire
</span></code></pre><ol start="3"><li>Specify what flavour you want to run in production:</li></ol><p>The first thing to do is choose what flavour of Bonfire you want to deploy, as each flavour uses different Docker images and set of configs. For example if you want to run the <code class="inline">classic</code> flavour:</p><ul><li><code class="inline">export MIX_ENV=prod FLAVOUR=classic</code> (you may also want to put this in the appropriate place in your system so your choice of flavour is remembered for next time)</li><li><code class="inline">just config</code></li></ul><p>This will initialise some default config (a .env file which won't be checked into git)</p><ol start="5"><li>Edit the config (especially the secrets) for the selected flavour in <code class="inline">./.env</code> (except if using the Bonfire co-op cloud recipe, which will create its own env file you should edit instead).</li></ol><p>These are the config keys you should especially pay attention to:</p><ul><li><code class="inline">HOSTNAME</code> (your domain name, eg: <code class="inline">bonfire.example.com</code>)</li><li><code class="inline">PUBLIC_PORT</code> (usually 443)</li><li><code class="inline">MAIL_DOMAIN</code> and <code class="inline">MAIL_KEY</code> and related keys to configure transactional email, for example set <code class="inline">MAIL_BACKEND=mailgun</code> and sign up at <a href="https://www.mailgun.com/">Mailgun</a> and then configure the domain name and key (you may also need to set <code class="inline">MAIL_BASE_URI</code> if your domain is not setup in EU, as the default <code class="inline">MAIL_BASE_URI</code> is set as <code class="inline">https://api.eu.mailgun.net/v3</code>). SMTP is supported as well. </li><li><code class="inline">UPLOADS_S3_BUCKET</code> and the related API key and secret for uploads. WARNING: If you want to store uploads in an object storage rather than directly on your server (which you probably want, to not run out of space), you need to configure that up front, otherwise URLs will break if you change it later. See <code class="inline">config/runtime.exs</code> for extra variables to set if you're not using the default service and region (which is <a href="https://www.scaleway.com/en/object-storage/">Scaleway</a> Paris).</li></ul><p>These are the secret keys for which you should put random secrets. You can run <code class="inline">just secrets</code> to generate some:</p><ul><li><code class="inline">SECRET_KEY_BASE</code></li><li><code class="inline">SIGNING_SALT</code></li><li><code class="inline">ENCRYPTION_SALT</code></li><li><code class="inline">POSTGRES_PASSWORD</code></li><li><code class="inline">MEILI_MASTER_KEY</code> </li></ul><h3 id="further-information-on-config" class="section-heading">
  <a href="#further-information-on-config" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">further-information-on-config</p>
  </a>
  Further information on config
</h3>
<p>The app needs some environment variables to be configured in order to work. The easy way to manage that is whit the <code class="inline">just</code> commands which take care of loading the environment for you.</p><p>In the <code class="inline">./config/</code> (which is a symbolic link to the config of the flavour you choose to run) directory of the codebase, there are following config files:</p><ul><li><code class="inline">config.exs</code>: default base configuration, which itself loads many other config files, such as one for each installed Bonfire extension.</li><li><code class="inline">prod.exs</code>: default extra configuration for <code class="inline">MIX_ENV=prod</code></li><li><code class="inline">runtime.exs</code>: extra configuration which is loaded at runtime (vs the others which are only loaded once at compile time, i.e. when you build a release)</li><li><code class="inline">bonfire_*.exs</code>: configs specific to different extensions, which are automatically imported by <code class="inline">config.exs</code></li></ul><p>You should <em>not</em> have to modify the files above. Instead, overload any settings from the above files using env variables or in <code class="inline">./.env</code>. </p><h2 id="step-2-install" class="section-heading">
  <a href="#step-2-install" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">step-2-install</p>
  </a>
  Step 2 - Install
</h2>
<h3 id="option-a-install-using-co-op-cloud-recommended" class="section-heading">
  <a href="#option-a-install-using-co-op-cloud-recommended" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">option-a-install-using-co-op-cloud-recommended</p>
  </a>
  Option A - Install using Co-op Cloud (recommended)
</h3>
<p><a href="https://coopcloud.tech">https://coopcloud.tech</a> is an alternative to corporate clouds built by tech co-ops, and provides very useful tools for setting up and managing many self-hosted free software tools using ready-to-use &quot;recipes&quot;.</p><p>If you're interested in hosting Bonfire alongside other open and/or federated projects, we recommend installing <a href="https://docs.coopcloud.tech/abra/">Abra</a>, <a href="https://docs.coopcloud.tech/operators/">setting up a co-op cloud server</a> and using the <a href="https://recipes.coopcloud.tech/bonfire">Bonfire recipe</a> (which provides it's own instructions, so read that and you can mostly ignore this document) to set up an instance. </p><h3 id="option-b-install-using-docker-containers-easy-mode" class="section-heading">
  <a href="#option-b-install-using-docker-containers-easy-mode" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">option-b-install-using-docker-containers-easy-mode</p>
  </a>
  Option B - Install using Docker containers (easy mode)
</h3>
<p>The easiest way to launch the docker image is using the just commands.
The <code class="inline">docker-compose.release.yml</code> uses <code class="inline">config/prod/.env</code> to launch a container with the necessary environment variables along with its dependencies, currently that means an extra postgres container, along with a reverse proxy (Caddy server, which you may want to replace with nginx or whatever you prefer).</p><h4>Install with docker-compose</h4><p>Make sure you have <a href="https://www.docker.com/">Docker</a>, a recent <a href="https://docs.docker.com/compose/install/#install-compose">docker-compose</a> (which supports v3 configs), and <a href="https://github.com/casey/just#packages">just</a> installed:</p><pre><code class="makeup sh" translate="no"><span class="gp unselectable">$ </span><span class="">docker version
</span><span class="">Docker version 18.09.1-ce
</span><span class="">
</span><span class="gp unselectable">$ </span><span class="">docker-compose -v
</span><span class="">docker-compose version 1.23.2
</span><span class="">
</span><span class="gp unselectable">$ </span><span class="">just --version
</span><span class="">just 1.1.3
</span><span class="">...
</span></code></pre><p>Now that your tooling is set up, you have the choice of using pre-built images or building your own. For example if your flavour does not have a prebuilt image on Docker Hub, or if you want to customise any of the extensions, you can build one yourself - see option A2 below. </p><h4>Option B1 - Using pre-built Docker images (recommended to start with)</h4><ul><li>The <code class="inline">image</code> entry in <code class="inline">docker-compose.release.yml</code> will by default use the image on Docker Hub which corresponds to your chosen flavour (see step 1 above for choosing your flavour).</li></ul><p>You can see the images available per flavour, version (we currently recommend using the <code class="inline">latest</code> tag), and architecture at <a href="https://hub.docker.com/r/bonfirenetworks/bonfire/tags">https://hub.docker.com/r/bonfirenetworks/bonfire/tags</a> </p><ul><li>Start the docker containers with docker-compose:</li></ul><pre><code class="makeup elixir" translate="no"><span class="n">just</span><span class="w"> </span><span class="n">rel</span><span class="o">-</span><span class="n">run</span></code></pre><p>Run this at the prompt: </p><p><code class="inline">bin/bonfire remote</code> to enter Elixir's iex environment
<code class="inline">EctoSparkles.Migrator.migrate</code> to initialise your database</p><p>The backend should now be running at <a href="http://localhost:4000/">http://localhost:4000/</a>.</p><ul><li>If that worked, start the app as a daemon next time:</li></ul><pre><code class="makeup elixir" translate="no"><span class="n">just</span><span class="w"> </span><span class="n">rel</span><span class="o">-</span><span class="n">run</span><span class="o">-</span><span class="n">bg</span></code></pre><h4>Docker-related handy commands</h4><ul><li><code class="inline">just update</code> to update to the latest release of Bonfire </li><li><code class="inline">just rel-run</code>                        Run the app in Docker, in the foreground</li><li><code class="inline">just rel-run-bg</code>                     Run the app in Docker, and keep running in the background</li><li><code class="inline">just rel-stop</code>                       Stop the running release</li><li><code class="inline">just rel-shell</code>                      Runs a simple shell inside of the container, useful to explore the image </li></ul><p>Once in the shell, you can run <code class="inline">bin/bonfire</code> with the following commands:
Usage: <code class="inline">bonfire COMMAND [ARGS]</code></p><p>The known commands are:</p><ul><li><code class="inline">start</code>          Starts the system</li><li><code class="inline">start_iex</code>      Starts the system with IEx attached</li><li><code class="inline">daemon</code>         Starts the system as a daemon</li><li><code class="inline">daemon_iex</code>     Starts the system as a daemon with IEx attached</li><li><code class="inline">eval &quot;EXPR&quot;</code>    Executes the given expression on a new, non-booted system</li><li><code class="inline">rpc &quot;EXPR&quot;</code>     Executes the given expression remotely on the running system</li><li><code class="inline">remote</code>         Connects to the running system via a IEx remote shell</li><li><code class="inline">restart</code>        Restarts the running system via a remote command</li><li><code class="inline">stop</code>           Stops the running system via a remote command</li><li><code class="inline">pid</code>            Prints the operating system PID of the running system via a remote command</li><li><code class="inline">version</code>        Prints the release name and version to be booted</li></ul><p>There are some useful database-related release tasks under <code class="inline">EctoSparkles.Migrator.</code> that can be run in an <code class="inline">iex</code> console (which you get to with <code class="inline">just rel.shell</code> followed by <code class="inline">bin/bonfire remote</code>, assuming the app is already running):</p><ul><li><code class="inline">migrate</code> runs all up migrations</li><li><code class="inline">rollback(step)</code> roll back to step X</li><li><code class="inline">rollback_to(version)</code> roll back to a specific version</li><li><code class="inline">rollback_all</code> rolls back all migrations back to zero (caution: this means losing all data)</li></ul><p>You can also directly call some functions in the code from the command line, for example:</p><ul><li>to migrate: <code class="inline">docker exec bonfire_web bin/bonfire rpc 'EctoSparkles.Migrator.migrate'</code></li><li>to just yourself an admin: <code class="inline">docker exec bonfire_web bin/bonfire rpc 'Bonfire.Me.Users.make_admin(&quot;my_username&quot;)'</code></li></ul><h4>Option B2 - Building your own Docker image</h4><p><code class="inline">Dockerfile.release</code> uses the <a href="https://docs.docker.com/develop/develop-images/multistage-build/">multistage build</a> feature to just the image as small as possible. It generates the OTP release which is later copied into the final image packaged in an Alpine linux container.</p><p>There is a <code class="inline">justfile</code> with relevant commands (make sure set the <code class="inline">MIX_ENV=prod</code> env variable):</p><ul><li><code class="inline">just rel-build-release</code> which builds the docker image of the latest release</li><li><code class="inline">just rel-build</code> which builds the docker image, including local changes to any cloned extensions in <code class="inline">./extensions/</code> </li><li><code class="inline">just rel-tag</code> adds the &quot;latest&quot; tag to your last build, so that it will be used when running</li></ul><p>Once you've built and tagged your image, you may need to update the <code class="inline">image</code> name in <code class="inline">docker-compose.release.release.yml</code> to match (either your local image name if running on the same machine you used for the build, or a remote image on Docker Hub if you pushed it) and then follow the same steps as for option A1.</p><p>For production, we recommend to set up a CI workflow to automate this, for an example you can look at the one <a href="../github/workflows/release.yaml">we currently use</a>.</p><hr class="thin"/><h3 id="option-c-manual-installation-without-docker" class="section-heading">
  <a href="#option-c-manual-installation-without-docker" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">option-c-manual-installation-without-docker</p>
  </a>
  Option C - Manual installation (without Docker)
</h3>
<h4>Dependencies</h4><ul><li>Postgres (or Postgis) version 12 or newer</li><li><a href="https://github.com/casey/just#packages">just</a></li><li>Elixir version 1.13 with OTP 24 (or newer). If your distribution only has an old version available, check <a href="https://elixir-lang.org/install.html">Elixir's install page</a> or use a tool like <a href="https://github.com/asdf-vm/asdf">asdf</a> (run <code class="inline">asdf install</code> in this directory).</li></ul><h4>C-1. Building the release</h4><ul><li><p>Make sure you have erlang and elixir installed (check <code class="inline">Dockerfile</code> for what version we're currently using)</p></li><li><p>Run <code class="inline">mix deps.get --only prod</code> to install elixir dependencies.</p></li><li><p>Prepare assets with <code class="inline">just js-deps-get</code>, <code class="inline">just assets-prepare</code> and <a href="https://hexdocs.pm/phoenix/1.7.0-rc.2/Mix.Tasks.Phx.Digest.html"><code class="inline">mix phx.digest</code></a></p></li><li><p>Run <a href="https://hexdocs.pm/mix/Mix.Tasks.Release.html"><code class="inline">mix release</code></a> to create an elixir release. This will create an executable in your <code class="inline">_build/prod/rel/bonfire</code> directory. We will be using the <code class="inline">bin/bonfire</code> executable from here on.</p></li></ul><h4>C-2. Running the release</h4><ul><li><p><code class="inline">cd _build/prod/rel/bonfire/</code></p></li><li><p>Create a database and run the migrations with <code class="inline">bin/bonfire eval 'EctoSparkles.Migrator.migrate()'</code>.</p></li><li><p>If you‚Äôre using RDS or some other locked down DB, you may need to run <code class="inline">CREATE EXTENSION IF NOT EXISTS citext WITH SCHEMA public;</code> on your database with elevated privileges.</p></li></ul><ul><li><p>You can check if your instance is configured correctly by running it with <code class="inline">bin/bonfire start</code></p></li><li><p>To run the instance as a daemon, use <code class="inline">bin/bonfire start daemon</code>.</p></li></ul><hr class="thin"/><h3 id="option-d-with-nix" class="section-heading">
  <a href="#option-d-with-nix" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">option-d-with-nix</p>
  </a>
  Option D - with Nix
</h3>
<p>This repo is a Flake and includes a Nix module.</p><p>Here are the detailed steps to deploy it:</p><ul><li>run a recent version of Nix or NixOS: <a href="https://nixos.wiki">https://nixos.wiki</a></li><li>enable Flakes: <a href="https://nixos.wiki/wiki/Flakes#Installing_flakes">https://nixos.wiki/wiki/Flakes#Installing_flakes</a></li><li>add <code class="inline">sandbox = false</code> in your nix.conf</li><li>fetch and build the app and dependencies: <code class="inline">nix run github:bonfire-networks/bonfire-app start_iex</code></li><li>add it as an input to your system flake.</li><li>add an overlay to just the package available</li><li>add the required configuration in your system</li></ul><p>Your <code class="inline">flake.nix</code> file would look like the following. Remember to replace <code class="inline">myHostName</code> with your actual hostname or however your deployed system is called.</p><pre><code class="nix">{
  inputs.bonfire.url = &quot;github:happysalada/bonfire-app/main&quot;;
  outputs = { self, nixpkgs, bonfire }: {
    overlay = final: prev: with final;{
      # a package named bonfire already exists on nixpkgs so we put it under a different name
      elixirBonfire = bonfire.packages.x86_64-linux.default;
    };
    nixosConfigurations.myHostName = nixpkgs.lib.nixosSystem {
      system = &quot;x86_64-linux&quot;;
      modules = [
        {
          environment.systemPackages = [ agenix.defaultPackage.x86_64-linux ];
          nixpkgs.overlays = [ self.overlay ];
        }
        ./myHostName.nix
        bonfire.nixosModules.bonfire
      ];
    };
  };
}</code></pre><p>Then your <code class="inline">myHostName.nix</code> would look like the following:</p><pre><code class="nix">{ config, lib, pkgs, ... }:

{
  services.bonfire = {
    # you will additionally need to expose bonfire with a reverse proxy, for example caddy
    port = 4000;
    package = pkgs.elixirBonfire;
    dbName = &quot;bonfire&quot;;
    # the environment should contain a minimum of
    #   SECRET_KEY_BASE
    #   SIGNING_SALT
    #   ENCRYPTION_SALT
    #   RELEASE_COOKIE
    # have a look into nix/module.nix for more details
    # the way to deploy secrets is beyond this readme, but I would recommend agenix
    environmentFile = &quot;/run/secrets/bonfireEnv&quot;;
    dbSocketDir = &quot;/var/run/postgresql&quot;;
  };
	
	# this is specifically for a reverse proxy, which is primarily used for SSL certs
	services.ngnix = {
		enable = true;
		forceSSL = true;
		enableACME = true;
		virtualHosts.&quot;myHostName&quot;.locations.proxyPass = &quot;http://localhost:4000&quot;;
	};
	
	# You will need to accept ACME's terms and conditions if you haven't elsewhere in your configuration
	security.acme.defaults.email = &quot;you@myHostName.com&quot;;
	security.acme.acceptTerms = true;

  # this is uniquely for database backup purposes
  # replace myBackupUserName with the user name that will do the backups
  # if you want to do backups differently, feel free to remove this part of the config
  services.postgresql = {
    ensureDatabases = [ &quot;bonfire&quot; ];
    ensureUsers = [{
      name = &quot;myBackupUserName&quot;;
      ensurePermissions = { &quot;DATABASE bonfire&quot; = &quot;ALL PRIVILEGES&quot;; };
    }];
  };
}</code></pre><h3 id="option-c-with-nixos" class="section-heading">
  <a href="#option-c-with-nixos" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">option-c-with-nixos</p>
  </a>
  Option C with nixos
</h3>
<p>this repo is a flake and includes a nixos module.
Here are the detailed steps to deploy it.</p><ul><li>add it as an input to your system flake.</li><li>add an overlay to just the package available</li><li>add the required configuration in your system</li></ul><p>Your flake.nix file would look like the following. Remember to replace myHostName with your actual hostname or however your deployed system is called.</p><pre><code class="nix">{
  inputs.bonfire.url = &quot;github:happysalada/bonfire-app/main&quot;;
  outputs = { self, nixpkgs, bonfire }: {
    overlay = final: prev: with final;{
      # a package named bonfire already exists on nixpkgs so we put it under a different name
      elixirBonfire = bonfire.defaultPackage.x86_64-linux;
    };
    nixosConfigurations.myHostName = nixpkgs.lib.nixosSystem {
      system = &quot;x86_64-linux&quot;;
      modules = [
        {
          environment.systemPackages = [ agenix.defaultPackage.x86_64-linux ];
          nixpkgs.overlays = [ self.overlay ];
        }
        ./myHostName.nix
        bonfire.nixosModules.bonfire
      ];
    };
  };
}</code></pre><p>then in myHostName.nix would look like the following</p><p>TODO: add the caddy config</p><pre><code class="nix">{ config, lib, pkgs, ... }:

{
  services.bonfire = {
    # you will need to expose bonfire with a reverse proxy, for example caddy
    port = 4000;
    package = pkgs.elixirBonfire;
    dbName = &quot;bonfire&quot;;
    # the environment should contain a minimum of
    #   SECRET_KEY_BASE
    #   SIGNING_SALT
    #   ENCRYPTION_SALT
    #   RELEASE_COOKIE
    # have a look into nix/module.nix for more details
    # the way to deploy secrets is beyond this readme, but I would recommend agenix
    environmentFile = &quot;/run/secrets/bonfireEnv&quot;;
    dbSocketDir = &quot;/var/run/postgresql&quot;;
  };

  # this is uniquely for database backup purposes
  # replace myBackupUserName with the user name that will do the backups
  # if you want to do backups differently, feel free to remove this part of the config
  services.postgresql = {
    ensureDatabases = [ &quot;bonfire&quot; ];
    ensureUsers = [{
      name = &quot;myBackupUserName&quot;;
      ensurePermissions = { &quot;DATABASE bonfire&quot; = &quot;ALL PRIVILEGES&quot;; };
    }];
  };
}</code></pre><h2 id="step-3-run" class="section-heading">
  <a href="#step-3-run" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">step-3-run</p>
  </a>
  Step 3 - Run
</h2>
<p>By default, the backend listens on port 4000 (TCP), so you can access it on <a href="http://localhost:4000/">http://localhost:4000/</a> (if you are on the same machine). In case of an error it will restart automatically.</p><p>Once you've signed up, you will automatically be an instance admin if you were the first to register.</p><hr class="thin"/><h4>Step 4 - Adding HTTPS</h4><p>The common and convenient way for adding HTTPS is by using a reverse proxy like Nginx or Caddyserver (the latter of which is bundled as part of the docker-compose setup).</p><p>Caddyserver and other servers can handle generating and setting up HTTPS certificates automatically, but if you need TLS/SSL certificates for nginx, you can look get some for free with <a href="https://letsencrypt.org/">letsencrypt</a>. The simplest way to obtain and install a certificate is to use <a href="https://certbot.eff.org">Certbot.</a>. Depending on your specific setup, certbot may be able to get a certificate and configure your web server automatically.</p><h2 id="troubleshooting" class="section-heading">
  <a href="#troubleshooting" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">troubleshooting</p>
  </a>
  Troubleshooting
</h2>
<p>Some common issues that may arise during deployment and our suggestions for resolving them.</p><h4>WebSocket connections not establishing behind a reverse proxy</h4><p>If you are running Bonfire behind your own reverse proxy (e.g. nginx), you might experience issues with WebSocket connections not establishing. WebSocket connections require specific configuration to work, in nginx the following configuration is necessary for websockets to work:</p><pre><code class="makeup elixir" translate="no"><span class="n">location</span><span class="w"> </span><span class="o">/</span><span class="n">live</span><span class="o">/</span><span class="n">websocket</span><span class="w"> </span><span class="p" data-group-id="1678459964-1">{</span><span class="w">
    </span><span class="n">proxy_pass</span><span class="w"> </span><span class="n">http</span><span class="ss">://</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">4000</span><span class="p">;</span><span class="w">
    
    </span><span class="c1"># these configurations are necessary to proxy WebSocket requests</span><span class="w">
    </span><span class="n">proxy_http_version</span><span class="w"> </span><span class="mf">1.1</span><span class="p">;</span><span class="w">
    </span><span class="n">proxy_set_header</span><span class="w"> </span><span class="nc">Upgrade</span><span class="w"> </span><span class="err">$</span><span class="n">http_upgrade</span><span class="p">;</span><span class="w">
    </span><span class="n">proxy_set_header</span><span class="w"> </span><span class="nc">Connection</span><span class="w"> </span><span class="s">&quot;upgrade&quot;</span><span class="p">;</span><span class="w">
</span><span class="p" data-group-id="1678459964-1">}</span></code></pre>
<div class="bottom-actions">
  <div class="bottom-actions-item">

      <a href="hacking.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ‚Üê Previous Page
        </span>
        <span class="title">
Development guide
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="architecture.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page ‚Üí
        </span>
        <span class="title">
Bonfire Architecture
        </span>
      </a>

  </div>
</div>

      <footer class="footer">

        <p>
          Built using
          <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.28.5) for the

            <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

        </p>
      </footer>
    </div>
  </div>
</section>
</div>


  </body>
</html>
